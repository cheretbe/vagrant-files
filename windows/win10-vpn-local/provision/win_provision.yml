---

- name: Windows box provision
  hosts: all

  tasks:
    - name: Print host information
      debug:
        msg: "{{ ansible_fqdn }}: {{ ansible_distribution }} {{ ansible_distribution_version}}"

    - name: Download DNS leak test script
      ansible.windows.win_get_url:
        url: "https://raw.githubusercontent.com/macvk/dnsleaktest/master/dnsleaktest.bat"
        dest: C:\users\vagrant\dnsleaktest.bat

    - name: Create IP info script
      ansible.windows.win_copy:
        content: |
          @ECHO OFF

          ECHO Querying https://freegeoip.app...
          powershell "Invoke-RestMethod https://freegeoip.app/json"

          ECHO Performing DNS leak test...
          CALL C:\Users\vagrant\dnsleaktest.bat

          ECHO Press any key to continue...
          PAUSE >NUL
        dest: "c:\\Users\\vagrant\\Desktop\\Get IP Info.bat"

    - name: Download Ookla Speedtest CLI archive
      ansible.windows.win_get_url:
        url: https://install.speedtest.net/app/cli/ookla-speedtest-1.0.0-win64.zip
        dest: C:\Users\vagrant\Downloads\ookla-speedtest-1.0.0-win64.zip

    - name: Extract Ookla Speedtest CLI archive
      community.windows.win_unzip:
        src: C:\Users\vagrant\Downloads\ookla-speedtest-1.0.0-win64.zip
        dest: C:\Users\vagrant

    - name: Create Speedtest wrapper script
      ansible.windows.win_copy:
        content: |
          @ECHO OFF

          C:\Users\vagrant\speedtest.exe

          ECHO Press any key to continue...
          PAUSE >NUL
        dest: "c:\\Users\\vagrant\\Desktop\\Speedtest.bat"

    - name: Create a script to ping 8.8.8.8 on the Desktop
      ansible.windows.win_copy:
        content: |
          @ECHO OFF
          ping -t 8.8.8.8
        dest: "c:\\Users\\vagrant\\Desktop\\ping 8.8.8.8.bat"

    - name: Create a script to ping 8.8.8.8 from the router on the Desktop
      ansible.windows.win_copy:
        content: |
          @ECHO OFF
          c:\Users\vagrant\plink.exe -batch vagrant@192.168.80.11 -i c:\vagrant\temp\vagrant_private_key.ppk "ping 8.8.8.8"
        dest: "c:\\Users\\vagrant\\Desktop\\ping from the router.bat"

    - name: Create startup script to ping 8.8.8.8
      ansible.windows.win_copy:
        content: |
          @ECHO OFF
          ping -t 8.8.8.8
        dest: "C:\\Users\\vagrant\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\ping 8.8.8.8.bat"

    - name: Download plink.exe
      ansible.windows.win_get_url:
        url: https://the.earth.li/~sgtatham/putty/latest/w64/plink.exe
        dest: C:\Users\vagrant\plink.exe

    - name: Create a script to view openvpn client log
      ansible.windows.win_copy:
        content: |
          @ECHO OFF
          c:\Users\vagrant\plink.exe -batch vagrant@192.168.80.11 -i c:\vagrant\temp\vagrant_private_key.ppk "sudo journalctl -u openvpn-client@purevpn.service -f"
        dest: "c:\\Users\\vagrant\\Desktop\\OpenVPN client log.bat"

    - name: Create a script to restart openvpn client
      ansible.windows.win_copy:
        content: |
          @ECHO OFF
          c:\Users\vagrant\plink.exe -batch vagrant@192.168.80.11 -i c:\vagrant\temp\vagrant_private_key.ppk "sudo service openvpn-client@purevpn restart"
        dest: "c:\\Users\\vagrant\\Desktop\\Restart OpenVPN client.bat"

    - name: Create a script to fix default route
      ansible.windows.win_copy:
        content: |
          @ECHO OFF

          route print -4
          powershell -noprofile -command "&{ start-process powershell -ArgumentList @('-NoProfile', '-NonInteractive', '-ExecutionPolicy', 'Bypass', '-File', 'c:\users\vagrant\win_setup_vpn.ps1', '-vpnGateway', '192.168.80.11') -verb RunAs}"
          route print -4

          ECHO Press any key to continue...
          PAUSE >NUL
        dest: "c:\\Users\\vagrant\\Desktop\\Fix default route.bat"

    - name: Create a script to init plink PPK key
      ansible.windows.win_copy:
        content: |
          @ECHO OFF

          c:\Users\vagrant\plink.exe vagrant@192.168.80.11 -i c:\vagrant\temp\vagrant_private_key.ppk "uname -a"

          ECHO Press any key to continue...
          PAUSE >NUL
        dest: "c:\\Users\\vagrant\\Desktop\\Init SSH key.bat"
